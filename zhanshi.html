<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻爬取工具</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        img { max-width: 200px; max-height: 150px; }
        .loading { display: none; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>澎湃新闻爬取工具</h1>
    <button onclick="runCrawler()">开始爬取</button>
    <div class="loading" id="loading">处理中... 请稍候</div>
    
    <table id="newsTable">
        <thead>
            <tr>
                <th>序号</th>
                <th>新闻链接</th>
                <th>预览图</th>
                <th>编辑链接</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // 存储爬取结果
        let newsData = [];
        const API_ID = "dQr1rU032rDgKZQgYCKQIn0dqT7ftFuK";
        const API_KEY = "qhl2OUHPgrfv3vs8vbr8sKRlDiTlZeOA";
        const APP_ID = "dQr1rU032rDgKZQgYCKQIn0dqT7ftFuK";
        const SECRET_KEY = "qhl2OUHPgrfv3vs8vbr8sKRlDiTlZeOA";
        const AGENT_API_URL = "https://agentapi.baidu.com/assistant/getAnswer";
        const WENXIN_API_URL = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions";

        async function runCrawler() {
            document.getElementById('loading').style.display = 'block';
            newsData = [];
            
            try {
                // 1. 爬取新闻链接
                const links = await fetchNewsLinks();
                
                // 2. 处理每个链接
                for (let i = 0; i < links.length; i++) {
                    const link = links[i];
                    const result = await processLink(link, i + 1);
                    newsData.push({
                        index: i + 1,
                        url: link,
                        previewUrl: result.previewUrl,
                        editUrl: result.editUrl,
                        imgUrl: result.imgUrl
                    });
                    
                    // 更新表格
                    updateTable();
                }
                
                // 3. 生成并保存Excel
                generateExcel();
                
                alert("处理完成！Excel文件已下载");
            } catch (error) {
                console.error("发生错误:", error);
                alert("处理出错: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function fetchNewsLinks() {
            const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.thepaper.cn/'));
            const data = await response.json();
            const html = data.contents;
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = [];
            const pattern = /newsDetail_forward_\d+/;
            
            doc.querySelectorAll('a[href]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && pattern.test(href)) {
                    const fullUrl = href.startsWith('/') ? 'https://www.thepaper.cn' + href : href;
                    if (links.length < 5 && !links.includes(fullUrl)) {
                        links.push(fullUrl);
                    }
                }
            });
            
            return links.slice(0, 5);
        }

        async function processLink(link, index) {
            // 获取access_token
            const authUrl = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${API_ID}&client_secret=${API_KEY}`;
            const authResp = await fetch(authUrl);
            const authData = await authResp.json();
            const access_token = authData.access_token;
            
            if (!access_token) throw new Error("获取access_token失败");
            
            // 调用智能体API
            const params = {
                message: {
                    content: {
                        type: "text",
                        value: { showText: link }
                    }
                },
                source: "web_crawler",
                from: "openapi",
                openId: "web_crawler_123"
            };
            
            const apiUrl = `${AGENT_API_URL}?appId=${APP_ID}&secretKey=${SECRET_KEY}`;
            const apiResp = await fetch(apiUrl, {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(params)
            });
            
            const result = await apiResp.json();
            
            // 提取链接
            const responseText = JSON.stringify(result);
            let previewUrl = "无预览链接";
            let editUrl = "无编辑链接";
            let imgUrl = null;
            
            const previewMatch = /\[点击这里查看思维导图\]\((https?:\/\/[^\)]+)\)/.exec(responseText);
            if (previewMatch) previewUrl = previewMatch[1];
            
            const editMatch = /\[点击这里进行编辑\]\((https?:\/\/[^\)]+)\)/.exec(responseText);
            if (editMatch) editUrl = editMatch[1];
            
            // 查找图片URL
            const imgRegex = /https:\/\/static\.shutu\.cn\/shutu\/jpeg\/opend7\/\d{4}\/\d{2}\/\d{2}\/[a-f0-9]{32}\.jpeg/g;
            const imgMatches = responseText.match(imgRegex);
            if (imgMatches && imgMatches.length > 0) {
                imgUrl = imgMatches[0];
            }
            
            return { previewUrl, editUrl, imgUrl };
        }

        function updateTable() {
            const tbody = document.querySelector('#newsTable tbody');
            tbody.innerHTML = '';
            
            newsData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.index}</td>
                    <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                    <td>${item.imgUrl ? `<img src="${item.imgUrl}" alt="预览图">` : '无图片'}</td>
                    <td><a href="${item.editUrl}" target="_blank">${item.editUrl}</a></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function generateExcel() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 准备数据
            const wsData = [["序号", "新闻链接", "预览图链接", "编辑链接"]];
            newsData.forEach(item => {
                wsData.push([
                    item.index,
                    item.url,
                    item.imgUrl || "无图片链接",
                    item.editUrl
                ]);
            });
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "新闻数据");
            
            // 生成并下载Excel
            XLSX.writeFile(wb, "news_data.xlsx");
        }
    </script>
</body>
</html>
